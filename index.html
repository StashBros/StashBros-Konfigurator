<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StashBros Produkt-Konfigurator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        label, input, button {
            margin: 10px 0;
            display: block;
        }
        input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: calc(100% - 22px); /* Adjust width to prevent overlap */
        }
        .output {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .footnote {
            margin-top: 20px;
            font-size: 0.9em;
            color: #555;
        }
        /* Wrapper für responsive Tabellen */
.table-wrapper {
    overflow-x: auto; /* Aktiviert horizontales Scrollen */
    margin: 10px 0; /* Abstand vor und nach der Tabelle */
}

table {
    width: 100%; /* Tabelle füllt den verfügbaren Platz */
    border-collapse: collapse; /* Entfernt doppelte Ränder */
}

th, td {
    padding: 8px; /* Platz in den Zellen */
    text-align: left; /* Links ausgerichtet */
}

@media (max-width: 768px) {
    table {
        font-size: 0.9rem; /* Kleinere Schriftgröße */
    }
    th, td {
        padding: 5px; /* Weniger Polsterung */
    }
}
.subtitle {
    text-align: center; /* Zentriert den Text */
    font-size: 0.9rem; /* Kleinere Schriftgröße */
    font-weight: normal; /* Normale Schrift, nicht fett */
    color: #555; /* Dezente Schriftfarbe */
    margin-top: 20px; /* Abstand zum Bild */
    margin-bottom: 15px; /* Abstand zu den nächsten Elementen */
    display: block; /* Sicherstellen, dass der Untertitel wie ein Block behandelt wird */
}
        /* Standard-Stil des Buttons */
    .send-button {
        background-color: #007BFF; /* Standardfarbe: Blau */
        color: white; /* Textfarbe: Weiß */
        padding: 10px; /* Abstand im Button */
        border: none; /* Keine Umrandung */
        border-radius: 5px; /* Abgerundete Ecken */
        cursor: pointer; /* Zeiger zeigt Hand an */
        font-size: 16px; /* Schriftgröße */
        transition: background-color 0.3s ease, color 0.3s ease; /* Sanfter Farbwechsel */
    }

    /* Stil beim Hover (Maus über dem Button) */
    .send-button:hover {
        background-color: #0056b3; /* Dunkleres Blau */
        color: #FFF; /* Text bleibt weiß */
    }
        /* Responsive image */
        .logo {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
            width: 50%; /* Set a maximum width for larger screens */
        }
    .yield-input {
        margin: 10px 0;
        display: block;
    }
    </style>
</head>
<body>
<div class="container">
    <img src="https://raw.githubusercontent.com/StashBros/StashBros-Konfigurator/56a0c6d9f082c5eb6b9f04c67ccf13587a92b915/StashBros_Logo_SB_SocialMedia_black.jpg" alt="StashBros Logo" class="logo">
    <p class="subtitle">Ermittle die optimale Produktzusammenstellung für deinen Club.</p>
    <label for="members">Mitgliederanzahl:</label>
    <input type="number" id="members" placeholder="z. B. 500" min="1">
    <label for="yield">Ertrag pro Pflanze (Gramm):</label>
    <input type="number" id="yield" class="yield-input" placeholder="z. B. 50" min="1" value="65">
    <label for="water-consumption">Wasserverbrauch pro Pflanze (L):</label>
    <input type="number" id="water-consumption" placeholder="z. B. 116,2" min="1" value="63">
    <label for="subscription-choice" style="margin-top: 20px; display: block;">Wähle eine Abo-Option:</label>
    <select id="subscription-choice" style="width: 100%; padding: 10px; margin-bottom: 20px;">
        <option value="10">10 Wochen</option>
        <option value="20">20 Wochen</option>
        <option value="40" selected>40 Wochen</option> <!-- Default selection -->
    </select>
    <button id="calculate-btn">Empfehlung berechnen</button>
    <div class="output" id="output"></div>
</div>

<script>
    const data = {
        members: 1, // Base on a single plant
        averageYield: 65,
        products: [
            { name: "Wurzel Complex", baseUsage: 0.048, sizes: [20, 10, 5, 2.5, 1, 0.5], prices: [166.00, 96.35, 59.45, 35.90, 17.15, 10.70] },
            { name: "TNT Complex", baseUsage: 0.02625, sizes: [20, 10, 5, 1, 0.5], prices: [54.15, 31.50, 19.35, 7.10, 5.30] },
            { name: "SuperVit", baseUsage: 0.00095, sizes: [0.5, 0.1, 0.05, 0.01], prices: [94.85, 22.60, 16.35, 6.65] },
            { name: "Coco", baseUsage: 0.28645, sizes: [20, 10, 5, 1], prices: [48.60, 27.70, 17.90, 6.35] },
            { name: "PowerZyme", baseUsage: 0.035838, sizes: [10, 5, 2.5, 1, 0.5], prices: [63.00, 35.45, 19.65, 8.45, 5.95] },
            { name: "PK 13/14", baseUsage: 0.03248, sizes: [20, 10, 5, 1, 0.5], prices: [91.00, 52.20, 29.85, 7.55, 5.50] },
            { name: "Boost", baseUsage: 0.0886, sizes: [10, 5, 2.5, 1, 0.5], prices: [50.50, 28.90, 15.55, 7.50, 5.15] }
        ],
        perPlantProducts: [
            { name: "Growbag", price: 14.99 },
            { name: "Cube", price: 1.99 }
        ]
    };

    function formatNumber(value) {
        return new Intl.NumberFormat("de-DE", {
            style: "currency",
            currency: "EUR"
        }).format(value);
    }

    function optimizeCombination(combination, sizes, prices) {
        sizes.sort((a, b) => b - a);
        const optimized = [];
        let carryOver = combination.reduce((sum, item) => sum + item.units * item.size, 0);

        for (const size of sizes) {
            if (carryOver >= size) {
                const units = Math.floor(carryOver / size);
                optimized.push({
                    size,
                    units,
                    price: prices[sizes.indexOf(size)]
                });
                carryOver %= size;
            }
        }

        if (carryOver > 0) {
            const smallestSize = sizes[sizes.length - 1];
            optimized.push({
                size: smallestSize,
                units: Math.ceil(carryOver / smallestSize),
                price: prices[sizes.indexOf(smallestSize)]
            });
        }

        return optimized;
    }

    function calculateRecommendations(members, yieldPerPlant, waterConsumption) {
        const plantsPerMember = 1500 / yieldPerPlant;
        const totalPlants = Math.ceil(members * plantsPerMember);
        const recommendations = data.products.map(product => {
            const precision = product.name === "SuperVit" ? 5 : 3;
            const totalUsage = parseFloat((product.baseUsage * totalPlants * (waterConsumption / 63)).toFixed(precision));
            let result = [];
            let remainder = totalUsage;

            for (let i = 0; i < product.sizes.length; i++) {
                const size = product.sizes[i];
                const price = product.prices[i];
                const units = Math.floor(remainder / size);
                if (units > 0) {
                    result.push({ size, price, units });
                    remainder = parseFloat((remainder - units * size).toFixed(precision));
                }
            }

            if (remainder > 0) {
                const smallestSize = product.sizes[product.sizes.length - 1];
                const smallestPrice = product.prices[product.prices.length - 1];
                const units = Math.ceil(remainder / smallestSize);
                result.push({ size: smallestSize, price: smallestPrice, units });
            }

            result = optimizeCombination(result, product.sizes, product.prices);

            if (product.name === "SuperVit") {
                let calculatedTotal = result.reduce((sum, item) => sum + item.units * item.size, 0);
                if (calculatedTotal > totalUsage) {
                    const excess = calculatedTotal - totalUsage;
                    for (let i = result.length - 1; i >= 0; i--) {
                        const item = result[i];
                        if (item.size <= excess && item.units > 0) {
                            item.units -= 1;
                            calculatedTotal -= item.size;
                            if (item.units === 0) result.splice(i, 1);
                            break;
                        }
                    }
                }
                result = result.reduce((acc, item) => {
                    const existing = acc.find(i => i.size === item.size);
                    if (existing) {
                        existing.units += item.units;
                    } else {
                        acc.push(item);
                    }
                    return acc;
                }, []);
            }

            const totalCost = result.reduce((sum, item) => sum + item.units * item.price, 0);

            return { name: product.name, totalUsage: `${totalUsage} L`, combination: result, totalCost };
        });

        data.perPlantProducts.forEach(product => {
            const totalUnits = Math.ceil(members * (150 / yieldPerPlant)); // Adjust based on yield
            const totalCost = totalUnits * product.price;
            recommendations.push({
                name: product.name,
                totalUsage: `${totalUnits} Stück`,
                combination: [{ size: 1, price: product.price, units: totalUnits }],
                totalCost
            });
        });

        return recommendations;
    }

    function calculateSubscriptionOptions(totalCost, plants, yieldPerPlant, recommendations) {
        const options = [
            { weeks: 10, discount: 0.02, months: 2.5 },
            { weeks: 20, discount: 0.07, months: 5 },
            { weeks: 40, discount: 0.15, months: 10 }
        ];

        return options.map(option => {
            const discountedTotalCost = recommendations.reduce((sum, rec) => {
                const discountedCost = rec.combination.reduce((subSum, comb) => {
                    return subSum + comb.units * getDiscountedPrice(comb.size, comb.price, option.weeks, rec.name);
                }, 0);
                return sum + discountedCost;
            }, 0);

            return {
                weeks: option.weeks,
                discountedPrice: discountedTotalCost,
                discountAmount: totalCost - discountedTotalCost,
                monthlyCost: discountedTotalCost / option.months,
                costPerPlant: discountedTotalCost / plants,
                costPerGram: discountedTotalCost / (yieldPerPlant * plants)
            };
        });
    }

    function getDiscountedPrice(size, price, weeks, productName) {
        let discount = 0;
        if (productName === "Growbag" || productName === "Cube") {
            if (weeks === 40) discount = 0.15;
            else if (weeks === 20) discount = 0.10;
            else if (weeks === 10) discount = 0.05;
        } else {
            if (weeks === 40) {
                if (size <= 1) discount = 0.15;
                else if (size <= 5) discount = 0.10;
                else discount = 0.08;
            } else if (weeks === 20) {
                if (size <= 1) discount = 0.10;
                else if (size <= 5) discount = 0.07;
                else discount = 0.05;
            } else if (weeks === 10) {
                if (size <= 1) discount = 0.05;
                else if (size <= 5) discount = 0.03;
                else discount = 0.02;
            }
        }
        return price * (1 - discount);
    }

    function displayRecommendations(recommendations, subscriptionOptions, totalCost) {
        const output = document.getElementById("output");
        const selectedWeeks = parseInt(document.getElementById("subscription-choice").value, 10); // Get selected subscription option
        let html = ""; // KORREKT: Variable wird initialisiert
        html += "<h3>Empfohlene Produkte</h3>";
        html += `<div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Produkt</th>
                        <th>Verbrauch 10-Wochen</th>
                        <th>Fassungsgrößen</th>
                        <th>Stückpreise (€)</th>
                        <th>Rabattierte Stückpreise (€)</th>
                        <th>Gesamtkosten (€)</th>
                        <th>Rabattierte Gesamtkosten (€)</th> <!-- New column -->
                    </tr>
                </thead>
                <tbody>`;
        recommendations.forEach(rec => {
            const combinationDetails = rec.combination.map(comb => 
                `${comb.units} x ${comb.size}${rec.name === "Growbag" || rec.name === "Cube" ? " Stück" : " L"}`
            ).join("<br>");
            const priceDetails = rec.combination.map(comb => 
                formatNumber(comb.price)
            ).join("<br>");
            const discountedPriceDetails = rec.combination.map(comb => 
                formatNumber(getDiscountedPrice(comb.size, comb.price, selectedWeeks, rec.name))
            ).join("<br>");
            const totalDiscountedCost = rec.combination.reduce((sum, comb) => 
                sum + comb.units * getDiscountedPrice(comb.size, comb.price, selectedWeeks, rec.name), 0);

            html += `
                <tr>
                    <td>${rec.name}</td>
                    <td>${rec.totalUsage}</td>
                    <td>${combinationDetails}</td>
                    <td>${priceDetails}</td>
                    <td>${discountedPriceDetails}</td>
                    <td>${formatNumber(rec.totalCost)}</td>
                    <td>${formatNumber(totalDiscountedCost)}</td> <!-- New column data -->
                </tr>`;
        });
        html += `</tbody></table></div>`;
        html += `<h3>Gesamtkosten: ${formatNumber(totalCost)}</h3>`;
        
        const totalDiscountedCostSum = recommendations.reduce((sum, rec) => {
            return sum + rec.combination.reduce((subSum, comb) => 
                subSum + comb.units * getDiscountedPrice(comb.size, comb.price, selectedWeeks, rec.name), 0);
        }, 0);
        html += `<h3>Rabattierte Gesamtkosten: ${formatNumber(totalDiscountedCostSum)}</h3>`; // Corrected field

        html += "<h3>Abo-Optionen</h3>";
        html += `<div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Wochen</th>
                        <th>Rabattierter Gesamtpreis (€)</th>
                        <th>Rabattierte Gesamtkosten (€)</th>
                        <th>Monatliche Kosten (€)</th>
                        <th>Kosten/Gramm (€)</th>
                        <th>Kosten/Pflanze (€)</th>
                        <th>Ersparnis (€)</th>
                    </tr>
                </thead>
                <tbody>`;
        subscriptionOptions.forEach(sub => {
            const rabattierteGesamtkosten = sub.weeks === 10
                ? sub.discountedPrice
                : sub.weeks === 20
                ? sub.discountedPrice * 2
                : sub.discountedPrice * 4;

            const monatlicheKosten = rabattierteGesamtkosten / (sub.weeks === 10 ? 2.5 : sub.weeks === 20 ? 5 : 10);

            const ersparnis = sub.weeks === 10
                ? sub.discountAmount
                : sub.weeks === 20
                ? sub.discountAmount * 2
                : sub.weeks === 40
                ? sub.discountAmount * 4
                : 0;

            html += `
                <tr>
                    <td>${sub.weeks} Wochen</td>
                    <td>${formatNumber(sub.discountedPrice)}</td>
                    <td>${formatNumber(rabattierteGesamtkosten)}</td>
                    <td>${formatNumber(monatlicheKosten)}</td>
                    <td>${formatNumber(sub.costPerGram)}</td>
                    <td>${formatNumber(sub.costPerPlant)}</td>
                    <td>${formatNumber(ersparnis)}</td>
                </tr>`;
        });
        html += `</tbody></table></div>`;
        
        html += `
        <div>
            <button id="send-recommendation" class="send-button">Anfrage senden</button>
        </div>`;

        html += `<p class="footnote">* 10 Wochen entsprechen einem Grow-Zyklus.</p>`;
        html += `<p class="footnote">* Nettopreise, zzgl. MwSt.</p>`;
        html += `<p class="footnote">* Pro Pflanze ∅ Verbrauch von 116,2 L Gießwasser pro Woche.</p>`;

        // Add discount information table
        html += `
        <p class="footnote">* Rabattinformationen:</p>
        <div class="table-wrapper" style="max-width: 400px;">
            <table style="font-size: 0.8rem;">
                <thead>
                    <tr>
                        <th>Produkt</th>
                        <th>40 Wochen</th>
                        <th>20 Wochen</th>
                        <th>10 Wochen</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Bis 1 L</td>
                        <td>15%</td>
                        <td>10%</td>
                        <td>5%</td>
                    </tr>
                    <tr>
                        <td>2,5 L und 5 L</td>
                        <td>10%</td>
                        <td>7%</td>
                        <td>3%</td>
                    </tr>
                    <tr>
                        <td>Ab 10 L</td>
                        <td>8%</td>
                        <td>5%</td>
                        <td>2%</td>
                    </tr>
                    <tr>
                        <td>Growbag und Cube</td>
                        <td>15%</td>
                        <td>10%</td>
                        <td>5%</td>
                    </tr>
                </tbody>
            </table>
        </div>`;
        output.innerHTML = html;
    }

    document.getElementById("calculate-btn").addEventListener("click", () => {
        const members = parseInt(document.getElementById("members").value, 10);
        const yieldPerPlant = parseFloat(document.getElementById("yield").value) || data.averageYield;
        const waterConsumption = parseFloat(document.getElementById("water-consumption").value) || 63;
        const selectedOption = document.getElementById("subscription-choice").value; // Get selected subscription option

        if (isNaN(members) || members < 1 || isNaN(yieldPerPlant) || yieldPerPlant < 1 || isNaN(waterConsumption) || waterConsumption < 1) {
            document.getElementById("output").innerHTML = '<p class="error-message">Bitte gib eine gültige Mitgliederanzahl, einen gültigen Ertrag pro Pflanze und einen gültigen Wasserverbrauch ein.</p>';
            return;
        }

        const recommendations = calculateRecommendations(members, yieldPerPlant, waterConsumption);
        const totalCost = recommendations.reduce((sum, rec) => sum + rec.totalCost, 0);
        const plants = Math.ceil(members * (150 / yieldPerPlant)); // Corrected calculation
        const subscriptionOptions = calculateSubscriptionOptions(totalCost, plants, yieldPerPlant, recommendations);

        displayRecommendations(recommendations, subscriptionOptions, totalCost);
        document.getElementById("subscription-choice").value = selectedOption; // Retain selected subscription option
    });

    document.getElementById("subscription-choice").addEventListener("change", () => {
        const members = parseInt(document.getElementById("members").value, 10);
        const yieldPerPlant = parseFloat(document.getElementById("yield").value) || data.averageYield;
        const waterConsumption = parseFloat(document.getElementById("water-consumption").value) || 63;

        if (isNaN(members) || members < 1 || isNaN(yieldPerPlant) || yieldPerPlant < 1 || isNaN(waterConsumption) || waterConsumption < 1) {
            document.getElementById("output").innerHTML = '<p class="error-message">Bitte gib eine gültige Mitgliederanzahl, einen gültigen Ertrag pro Pflanze und einen gültigen Wasserverbrauch ein.</p>';
            return;
        }

        const recommendations = calculateRecommendations(members, yieldPerPlant, waterConsumption);
        const totalCost = recommendations.reduce((sum, rec) => sum + rec.totalCost, 0);
        const plants = Math.ceil(members * (150 / yieldPerPlant)); // Corrected calculation
        const subscriptionOptions = calculateSubscriptionOptions(totalCost, plants, yieldPerPlant, recommendations);

        displayRecommendations(recommendations, subscriptionOptions, totalCost);
    });

    document.addEventListener("click", (event) => {
        if (event.target.id === "send-recommendation") {
            const selectedOption = document.getElementById("subscription-choice").value;
            const members = document.getElementById("members").value;
            const yieldPerPlant = document.getElementById("yield").value;

            if (!selectedOption) {
                alert("Bitte wähle eine Abo-Option aus, bevor du die Anfrage abschickst.");
                return;
            }

            if (!members || parseInt(members, 10) < 1) {
                alert("Bitte gib eine gültige Mitgliederanzahl ein, bevor du die Anfrage abschickst.");
                return;
            }

            if (!yieldPerPlant || parseFloat(yieldPerPlant) < 1) {
                alert("Bitte gib einen gültigen Ertrag pro Pflanze ein, bevor du die Anfrage abschickst.");
                return;
            }

            const emailBody = `
Hallo StashBros-Team,

ich habe die Empfehlung berechnen lassen und interessiere mich für die Abo-Option ${selectedOption} Wochen bei ${members} Mitgliedern und einem Ertrag pro Pflanze von ${yieldPerPlant} Gramm.

Ihr könnt mich gerne für weitere Rückfragen unter folgenden Kontaktdaten erreichen:

- Club - Name: [Hier Club-Namen einfügen]
- Ansprechpartner: [Hier Namen des Ansprechpartners einfügen]
- Telefon: [Hier Telefonnummer einfügen]
- E-Mail: [Hier E-Mail-Adresse einfügen]

Mit freundlichen Grüßen,
            `;

            const email = "info@stashbros.de";
            const subject = `Empfehlung: ${selectedOption}-Wochen Abo-Option, ${members} Mitglieder, ${yieldPerPlant} g/Pflanze`;

            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        }
    });
</script>
</body>
</html>
